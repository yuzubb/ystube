<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Watch - YStube</title>
    <style>
        :root {
            --accent: #00d4ff;
            --bg: #05070a;
            --panel: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --text-sub: rgba(255, 255, 255, 0.5);
        }

        body {
            margin: 0; background: var(--bg); color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        /* Layout */
        .container {
            max-width: 1300px; margin: 0 auto; padding: 20px;
            display: grid; grid-template-columns: 1fr 350px; gap: 24px;
        }

        /* Player Area */
        .player-section { width: 100%; }
        #video-viewport {
            width: 100%; aspect-ratio: 16/9; background: #000;
            border-radius: 12px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            margin-bottom: 15px;
        }
        video { width: 100%; height: 100%; outline: none; }

        /* Quality Selector */
        .quality-bar {
            display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px;
            padding: 10px; background: var(--panel); border-radius: 8px;
        }
        .q-btn {
            background: transparent; border: 1px solid var(--border); color: white;
            padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;
            transition: 0.2s;
        }
        .q-btn:hover { border-color: var(--accent); }
        .q-btn.active { background: var(--accent); color: #000; border-color: var(--accent); font-weight: bold; }

        /* Meta Info */
        .v-title { font-size: 1.25rem; margin: 15px 0; font-weight: 600; line-height: 1.4; }
        .channel-row {
            display: flex; align-items: center; gap: 12px; padding: 15px 0;
            border-bottom: 1px solid var(--border); margin-bottom: 20px;
        }
        .c-icon { width: 48px; height: 48px; border-radius: 50%; background: #222; }
        .c-details { flex: 1; }
        .c-name { font-weight: bold; display: block; }
        .v-stats { font-size: 0.85rem; color: var(--text-sub); }

        /* Comments & Sidebar */
        .section-title { font-size: 1.1rem; margin-bottom: 15px; border-left: 3px solid var(--accent); padding-left: 10px; }
        .comment-item { display: flex; gap: 12px; margin-bottom: 18px; font-size: 0.9rem; }
        .related-item {
            display: flex; gap: 10px; text-decoration: none; color: inherit; margin-bottom: 15px;
        }
        .r-thumb { width: 140px; aspect-ratio: 16/9; border-radius: 6px; object-fit: cover; }
        .r-title { font-size: 0.85rem; font-weight: 500; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

        @media (max-width: 1000px) {
            .container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="player-section">
        <div id="video-viewport">
            <video id="main-video" controls autoplay playsinline></video>
        </div>

        <div class="quality-bar" id="quality-bar">
            </div>

        <h1 class="v-title" id="v-title">Loading...</h1>

        <div class="channel-row">
            <img src="" class="c-icon" id="c-icon">
            <div class="c-details">
                <span class="c-name" id="c-name">---</span>
                <div class="v-stats">
                    Views: <span id="v-views">-</span> • Likes: <span id="v-likes">-</span>
                </div>
            </div>
        </div>

        <div class="section-title">Comments</div>
        <div id="comments-box"></div>
    </div>

    <aside class="sidebar">
        <div class="section-title">Related</div>
        <div id="related-box"></div>
    </aside>
</div>

<script>
    const videoId = "{{ video_id }}";
    const videoEl = document.getElementById('main-video');

    async function init() {
        try {
            const res = await fetch(`/api/stream/${videoId}`);
            const data = await res.json();

            // 1. メタデータのセット
            document.title = data.title + " - YStube";
            document.getElementById('v-title').innerText = data.title;
            document.getElementById('v-views').innerText = data.views || "0";
            document.getElementById('v-likes').innerText = data.likes || "0";
            document.getElementById('c-name').innerText = data.channel?.name || "Unknown Channel";
            document.getElementById('c-icon').src = data.channel?.icon || "";

            // 2. 画質切り替えと初期再生 (itag 18)
            if (data.formats) {
                const qBar = document.getElementById('quality-bar');
                // 解像度があるもの（動画）だけ抽出
                const videoFormats = data.formats.filter(f => f.resolution !== "audio only");
                
                videoFormats.forEach(f => {
                    const btn = document.createElement('button');
                    btn.className = 'q-btn';
                    if (f.itag === "18") btn.classList.add('active');
                    btn.innerText = f.resolution;
                    
                    btn.onclick = () => {
                        const time = videoEl.currentTime;
                        const isPaused = videoEl.paused;
                        document.querySelectorAll('.q-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        videoEl.src = f.url;
                        videoEl.currentTime = time;
                        if (!isPaused) videoEl.play();
                    };
                    qBar.appendChild(btn);
                });

                // itag 18 で開始
                const defaultF = videoFormats.find(f => f.itag === "18") || videoFormats[0];
                if (defaultF) videoEl.src = defaultF.url;
            }

            // 3. コメントの流し込み
            if (data.comments) {
                document.getElementById('comments-box').innerHTML = data.comments.map(c => `
                    <div class="comment-item">
                        <img src="${c.authorIcon}" style="width:36px; height:36px; border-radius:50%;">
                        <div>
                            <div style="font-weight:bold; font-size:0.8rem; color:var(--text-sub);">${c.authorName}</div>
                            <div style="margin-top:4px;">${c.text}</div>
                        </div>
                    </div>
                `).join('');
            }

            // 4. 関連動画の流し込み
            if (data.related) {
                document.getElementById('related-box').innerHTML = data.related.map(r => `
                    <a href="/watch?v=${r.id}" class="related-item">
                        <img src="${r.thumbnail}" class="r-thumb">
                        <div class="r-info">
                            <div class="r-title">${r.title}</div>
                            <div style="font-size:0.75rem; color:var(--text-sub); margin-top:4px;">${r.channelName}</div>
                        </div>
                    </a>
                `).join('');
            }

        } catch (e) {
            console.error(e);
            document.getElementById('v-title').innerText = "Failed to load video data.";
        }
    }

    init();
</script>

</body>
</html>
