<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ word }} - YStube</title>
    <style>
        :root {
            --accent: #00d4ff;
            --bg: #05070a;
            --panel: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
        }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; }
        
        /* Header */
        header { position: sticky; top: 0; z-index: 100; background: rgba(5,7,10,0.9); backdrop-filter: blur(15px); padding: 12px 5%; display: flex; align-items: center; gap: 20px; border-bottom: 1px solid var(--border); }
        .logo { font-size: 1.2rem; letter-spacing: 4px; text-decoration: none; color: white; }
        .search-input { flex: 1; width: 100%; background: var(--panel); border: 1px solid var(--border); border-radius: 8px; padding: 10px 15px; color: white; outline: none; }

        /* Grid System */
        .content { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .results-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; }

        .item { text-decoration: none; color: inherit; transition: 0.3s; }
        .item:hover { transform: translateY(-5px); }
        .thumb-box { position: relative; width: 100%; aspect-ratio: 16/9; background: #111; border-radius: 12px; overflow: hidden; border: 1px solid var(--border); }
        .thumb-img { width: 100%; height: 100%; object-fit: cover; }
        
        .badge { position: absolute; bottom: 8px; right: 8px; background: rgba(0,0,0,0.8); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; }
        
        .info { padding: 10px 5px; }
        .title { font-size: 1rem; font-weight: bold; margin-bottom: 5px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .meta { font-size: 0.85rem; color: rgba(255,255,255,0.5); }

        /* Load More */
        .load-more-container { text-align: center; padding: 50px 0; }
        #load-more-btn { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 12px 40px; border-radius: 30px; cursor: pointer; font-weight: bold; letter-spacing: 2px; transition: 0.3s; }
        #load-more-btn:hover { background: var(--accent); color: #000; }

        /* Suggestions */
        #suggestions { position: absolute; top: 100%; left: 0; right: 0; background: #0f1218; border: 1px solid var(--border); border-radius: 8px; list-style: none; padding: 5px 0; margin: 5px 0 0 0; display: none; z-index: 1000; }
        #suggestions li { padding: 10px 15px; cursor: pointer; }
        #suggestions li:hover { background: rgba(255,255,255,0.05); color: var(--accent); }
    </style>
</head>
<body>

<header>
    <a href="/" class="logo">YS</a>
    <div style="flex:1; position:relative; max-width:500px;">
        <form action="/search" method="GET" id="search-form">
            <input type="text" name="q" id="search-input" class="search-input" value="{{ word }}" autocomplete="off">
        </form>
        <ul id="suggestions"></ul>
    </div>
</header>

<main class="content">
    <div class="results-grid" id="results-grid">
        {% for item in results %}
        <a href="/watch?v={{ item.id }}" class="item type-{{ item.type }}">
            <div class="thumb-box">
                <img src="https://img.youtube.com/vi/{{ item.id }}/0.jpg" class="thumb-img" loading="lazy">
                {% if item.type == 'playlist' %}<div class="badge">PLAYLIST</div>{% endif %}
                {% if item.length %}<div class="badge">{{ item.length }}</div>{% endif %}
            </div>
            <div class="info">
                <div class="title">{{ item.title }}</div>
                <div class="meta">
                    {{ item.author }} • {{ item.published }}
                    {% if item.view_count_text %} • {{ item.view_count_text }}{% endif %}
                </div>
            </div>
        </a>
        {% endfor %}
    </div>

    <div class="load-more-container">
        <button id="load-more-btn" data-next="{{ next }}">LOAD MORE</button>
    </div>
</main>

<script>
    // --- Suggest Logic ---
    const input = document.getElementById('search-input');
    const suggList = document.getElementById('suggestions');
    window.callback = (data) => {
        const items = data[1] || [];
        if (items.length > 0) {
            suggList.innerHTML = items.map(t => `<li>${t}</li>`).join('');
            suggList.style.display = 'block';
        } else { suggList.style.display = 'none'; }
    };
    input.addEventListener('input', () => {
        const q = input.value.trim();
        if (!q) { suggList.style.display = 'none'; return; }
        const s = document.createElement('script');
        s.src = `https://suggestqueries.google.com/complete/search?client=firefox&ds=yt&q=${encodeURIComponent(q)}&callback=callback`;
        document.body.appendChild(s);
        s.onload = () => s.remove();
    });
    suggList.addEventListener('click', (e) => {
        if(e.target.tagName === 'LI') {
            input.value = e.target.innerText;
            document.getElementById('search-form').submit();
        }
    });

    // --- Load More Logic (Invidious /search 形式) ---
    const loadMoreBtn = document.getElementById('load-more-btn');
    const resultsGrid = document.getElementById('results-grid');

    loadMoreBtn.addEventListener('click', async () => {
        const nextUrl = loadMoreBtn.getAttribute('data-next');
        if (!nextUrl) return;

        loadMoreBtn.innerText = "LOADING...";
        loadMoreBtn.disabled = true;

        try {
            // /search?q=...&page=... をそのままfetch
            const response = await fetch(nextUrl);
            const text = await response.text();
            
            // 返ってきたHTMLから結果グリッドの中身だけ抽出
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, 'text/html');
            const newItems = doc.querySelectorAll('#results-grid .item');
            const nextBtn = doc.getElementById('load-more-btn');

            if (newItems.length > 0) {
                newItems.forEach(item => resultsGrid.appendChild(item));
                loadMoreBtn.setAttribute('data-next', nextBtn.getAttribute('data-next'));
                loadMoreBtn.innerText = "LOAD MORE";
                loadMoreBtn.disabled = false;
            } else {
                loadMoreBtn.innerText = "NO MORE RESULTS";
            }
        } catch (e) {
            console.error(e);
            loadMoreBtn.innerText = "ERROR - RETRY";
            loadMoreBtn.disabled = false;
        }
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('header')) suggList.style.display = 'none';
    });
</script>

</body>
</html>
